<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D Model Viewer</title>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <link rel="stylesheet" href="modelviewer_style.css">
  <link rel="stylesheet" href="https://use.typekit.net/zfi8dmc.css"> 
</head>

<body>
  <model-viewer ar id="modelViewer"
    ar-modes="webxr scene-viewer quick-look"
    src=""
    ios-src=""
    shadow-intensity="1"
    shadow-softness="1"
    camera-controls
    touch-action="pan-y pan-x none"
    camera-orbit="-25deg 75deg auto"
    scale="1 1 1"
    orbit-sensitivity="2">
    
    <!-- Hotspot buttons -->
    <button style="background-color:rgb(0,0,0)" slot="hotspot-dot+X-Y+Z" class="dot" data-position="1 -1 1" data-normal="1 0 0"></button>
    <button slot="hotspot-dim+X-Y" class="dim" data-position="1 -1 0" data-normal="1 0 0"></button>
    <button style="background-color:rgb(0,0,0)" slot="hotspot-dot+X-Y-Z" class="dot" data-position="1 -1 -1" data-normal="1 0 0"></button>
    <button slot="hotspot-dim+X-Z" class="dim" data-position="1 0 -1" data-normal="1 0 0"></button>
    <button style="background-color:rgb(0,0,0)" slot="hotspot-dot+X+Y-Z" class="dot" data-position="1 1 -1" data-normal="0 1 0"></button>
    <button slot="hotspot-dim+Y-Z" class="dim" data-position="0 -1 -1" data-normal="0 1 0"></button>
    <button style="background-color:rgb(0,0,0)" slot="hotspot-dot-X+Y-Z" class="dot" data-position="-1 1 -1" data-normal="0 1 0"></button>
    <button slot="hotspot-dim-X-Z" class="dim" data-position="-1 0 -1" data-normal="-1 0 0"></button>
    <button style="background-color:rgb(0,0,0)" slot="hotspot-dot-X-Y-Z" class="dot" data-position="-1 -1 -1" data-normal="-1 0 0"></button>
    <button slot="hotspot-dim-X-Y" class="dim" data-position="-1 -1 0" data-normal="-1 0 0"></button>
    <button style="background-color:rgb(0,0,0)" slot="hotspot-dot-X-Y+Z" class="dot" data-position="-1 -1 1" data-normal="-1 0 0"></button>
    <svg id="dimLines" width="100%" height="100%" class="dimensionLineContainer">
      <line class="dimensionLine"></line>
      <line class="dimensionLine"></line>
      <line class="dimensionLine"></line>
      <line class="dimensionLine"></line>
      <line class="dimensionLine"></line>
    </svg>
    
    <!-- AR button icon -->
    <img id="ar-button" src="icon/arbtn.png" slot="ar-button" alt="arbtn">
  </model-viewer>

  <!-- UI Elements outside AR -->
  <div id="buttonsGRP">
    <a href="newMenu.html"><img class="return" src="icon/returnbtn.png" alt="return"></a>
    <img class="specification" src="icon/infobtn.png" alt="specification" id="specButton">
  </div>

  <div id="arOverlay" class="ar-overlay">
    <div class="loadingText"><img src="icon/explanation.png"></div>
  </div>

  <div class="spec-overlay" id="specOverlay">
    <h2>製品仕様</h2>
    <p></p>
    <a id="modelLink" href="#" target="_blank">製品仕様</a> 
    <div id="iframeWrapper"><button id="closeIframeBtn">×</button><iframe title="model" id="modelIframe"></iframe></div>
    <img src="icon/returnbtn.png" class="close-spec" id="closeSpec">
  </div>

  <script type="module">
    const modelViewer = document.getElementById('modelViewer');
    const urlParams = new URLSearchParams(window.location.search);
    const modelUrl = urlParams.get('model');
    
    if (modelUrl) {
      const baseName = modelUrl.split('/').pop().split('.')[0]; // e.g. model.glb → model
      const glbPath = modelUrl;
      // safer replacement for .glb extension (ignore query params)
      const usdzPath = modelUrl.replace(/\.glb(\?.*)?$/, '.usdz');

      modelViewer.setAttribute('src', glbPath);
      modelViewer.setAttribute('ios-src', usdzPath);
    }

    const dimElements = [...modelViewer.querySelectorAll('button'), modelViewer.querySelector('#dimLines')];
    const dimLines = modelViewer.querySelectorAll('line');

    function drawLine(svgLine, dotHotspot1, dotHotspot2, dimensionHotspot) {
      if (dotHotspot1 && dotHotspot2) {
        svgLine.setAttribute('x1', dotHotspot1.canvasPosition.x);
        svgLine.setAttribute('y1', dotHotspot1.canvasPosition.y);
        svgLine.setAttribute('x2', dotHotspot2.canvasPosition.x);
        svgLine.setAttribute('y2', dotHotspot2.canvasPosition.y);

        if (dimensionHotspot && !dimensionHotspot.facingCamera) {
          svgLine.classList.add('hide');
        } else {
          svgLine.classList.remove('hide');
        }
      }
    }

    const renderSVG = () => {
      drawLine(dimLines[0], modelViewer.queryHotspot('hotspot-dot+X-Y+Z'), modelViewer.queryHotspot('hotspot-dot+X-Y-Z'), modelViewer.queryHotspot('hotspot-dim+X-Y'));
      drawLine(dimLines[1], modelViewer.queryHotspot('hotspot-dot+X-Y-Z'), modelViewer.queryHotspot('hotspot-dot+X+Y-Z'), modelViewer.queryHotspot('hotspot-dim+X-Z'));
      drawLine(dimLines[2], modelViewer.queryHotspot('hotspot-dot+X+Y-Z'), modelViewer.queryHotspot('hotspot-dot-X+Y-Z'));
      drawLine(dimLines[3], modelViewer.queryHotspot('hotspot-dot-X+Y-Z'), modelViewer.queryHotspot('hotspot-dot-X-Y-Z'), modelViewer.queryHotspot('hotspot-dim-X-Z'));
      drawLine(dimLines[4], modelViewer.queryHotspot('hotspot-dot-X-Y-Z'), modelViewer.queryHotspot('hotspot-dot-X-Y+Z'), modelViewer.queryHotspot('hotspot-dim-X-Y'));
    };

    modelViewer.addEventListener('load', () => {
      const center = modelViewer.getBoundingBoxCenter();
      const size = modelViewer.getDimensions();
      const x2 = size.x / 2, y2 = size.y / 2, z2 = size.z / 2;
      
      modelViewer.updateHotspot({ name: 'hotspot-dot+X-Y+Z', position: `${center.x + x2} ${center.y - y2} ${center.z + z2}` });
      modelViewer.updateHotspot({ name: 'hotspot-dim+X-Y', position: `${center.x + x2 * 1.2} ${center.y - y2 * 1.1} ${center.z}` });
      modelViewer.querySelector('button[slot="hotspot-dim+X-Y"]').textContent = `${(size.z).toFixed(1)} m`;

      modelViewer.updateHotspot({ name: 'hotspot-dot+X-Y-Z', position: `${center.x + x2} ${center.y - y2} ${center.z - z2}` });
      modelViewer.updateHotspot({ name: 'hotspot-dim+X-Z', position: `${center.x + x2 * 1.2} ${center.y} ${center.z - z2 * 1.2}` });
      modelViewer.querySelector('button[slot="hotspot-dim+X-Z"]').textContent = `${(size.y).toFixed(1)} m`;

      modelViewer.updateHotspot({ name: 'hotspot-dot+X+Y-Z', position: `${center.x + x2} ${center.y + y2} ${center.z - z2}` });
      modelViewer.updateHotspot({ name: 'hotspot-dim+Y-Z', position: `${center.x} ${center.y + y2 * 1.1} ${center.z - z2 * 1.1}` });
      modelViewer.querySelector('button[slot="hotspot-dim+Y-Z"]').textContent = `${(size.x).toFixed(1)} m`;

      modelViewer.updateHotspot({ name: 'hotspot-dot-X+Y-Z', position: `${center.x - x2} ${center.y + y2} ${center.z - z2}` });
      modelViewer.updateHotspot({ name: 'hotspot-dim-X-Z', position: `${center.x - x2 * 1.2} ${center.y} ${center.z - z2 * 1.2}` });
      modelViewer.querySelector('button[slot="hotspot-dim-X-Z"]').textContent = `${(size.y).toFixed(1)} m`;

      modelViewer.updateHotspot({ name: 'hotspot-dot-X-Y-Z', position: `${center.x - x2} ${center.y - y2} ${center.z - z2}` });
      modelViewer.updateHotspot({ name: 'hotspot-dim-X-Y', position: `${center.x - x2 * 1.2} ${center.y - y2 * 1.1} ${center.z}` });
      modelViewer.querySelector('button[slot="hotspot-dim-X-Y"]').textContent = `${(size.z).toFixed(1)} m`;

      modelViewer.updateHotspot({ name: 'hotspot-dot-X-Y+Z', position: `${center.x - x2} ${center.y - y2} ${center.z + z2}` });

      renderSVG();

      const maxDim = Math.max(size.x, size.y, size.z);
      modelViewer.cameraOrbit = `0deg 75deg ${maxDim * 10.5}m`;
    });
    
    function animationLoop() {
      renderSVG();
      requestAnimationFrame(animationLoop);
    }

    animationLoop(); // Start loop

    // AR overlay start delay logic
    const arButton = document.querySelector('#ar-button');
    const arOverlay = document.getElementById('arOverlay');
    let arJustStarted = false, arTimeout = null;

    function startAR() {
      arOverlay.style.display = 'none';
      arJustStarted = false;
      modelViewer.activateAR();
    }

    arButton.addEventListener('click', (event) => {
      if (!arJustStarted) {
        event.preventDefault();
        arOverlay.style.display = 'flex';
        arJustStarted = true;
        arTimeout = setTimeout(startAR, 5000);
      }
    });

    arOverlay.addEventListener('click', () => {
      if (arJustStarted) {
        clearTimeout(arTimeout);
        startAR();
      }
    });

    modelViewer.addEventListener('ar-status', (event) => {
      if (event.detail.status === 'not-presenting') {
        arOverlay.style.display = 'none';
        arJustStarted = false;
        clearTimeout(arTimeout);
      }
    });

    // Specifications overlay logic
    const specButton = document.getElementById('specButton');
    const specOverlay = document.getElementById('specOverlay');
    const closeSpec = document.getElementById('closeSpec');
    const modelLink = document.getElementById('modelLink');
    const iframeWrapper = document.getElementById('iframeWrapper');
    const modelIframe = document.getElementById('modelIframe');
    const closeIframeBtn = document.getElementById('closeIframeBtn');

    specButton.addEventListener('click', () => {
      specOverlay.style.display = 'flex';
    });

    closeSpec.addEventListener('click', () => {
      specOverlay.style.display = 'none';
      iframeWrapper.style.display = 'none';
      modelIframe.src = "";
    });

    closeIframeBtn.addEventListener('click', () => {
      iframeWrapper.style.display = 'none';
      modelIframe.src = '';
    });
  </script>
</body>
</html>
